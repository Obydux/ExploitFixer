package twolovers.exploitfixer.bungee;

import net.md_5.bungee.api.plugin.Plugin;
import net.md_5.bungee.api.plugin.PluginManager;
import net.md_5.bungee.config.Configuration;
import twolovers.exploitfixer.bungee.commands.ExploitFixerCommand;
import twolovers.exploitfixer.bungee.listeners.ChatListener;
import twolovers.exploitfixer.bungee.listeners.DisconnectListener;
import twolovers.exploitfixer.bungee.listeners.PluginMessageListener;
import twolovers.exploitfixer.bungee.listeners.PostLoginListener;
import twolovers.exploitfixer.bungee.managers.BungeeModuleManager;
import twolovers.exploitfixer.bungee.utils.ConfigurationUtil;
import twolovers.exploitfixer.interfaces.managers.ExploitPlayerManager;
import twolovers.exploitfixer.interfaces.managers.ModuleManager;

import java.util.concurrent.TimeUnit;

public class ExploitFixer extends Plugin {
	private static ExploitFixer plugin;
	private ModuleManager moduleManager;

	public void onEnable() {
		final ConfigurationUtil configurationUtil = new ConfigurationUtil(this);

		configurationUtil.createConfiguration("%datafolder%/config.yml");
		configurationUtil.createConfiguration("%datafolder%/messages.yml");

		final Configuration configYml = configurationUtil.getConfiguration("%datafolder%/config.yml");
		final Configuration messagesYml = configurationUtil.getConfiguration("%datafolder%/messages.yml");

		plugin = this;
		this.moduleManager = new BungeeModuleManager(configYml, messagesYml);

		reload();

		getProxy().getScheduler().schedule(this, () -> {
			final ExploitPlayerManager exploitPlayerManager = moduleManager.getExploitPlayerManager();

			if (!exploitPlayerManager.getExploitPlayers().isEmpty()) {
				exploitPlayerManager.reload();
				System.out.println("[ExploitFixer] Automatically cleared unused cached players!");
			}
		}, 5, 5, TimeUnit.MINUTES);
	}

	public void reload() {
		final ConfigurationUtil configurationUtil = new ConfigurationUtil(this);

		configurationUtil.createConfiguration("%datafolder%/config.yml");
		configurationUtil.createConfiguration("%datafolder%/messages.yml");

		final Configuration configYml = configurationUtil.getConfiguration("%datafolder%/config.yml");
		final Configuration messagesYml = configurationUtil.getConfiguration("%datafolder%/messages.yml");
		moduleManager.reload(configYml, messagesYml, null);
		final PluginManager pluginManager = plugin.getProxy().getPluginManager();

		pluginManager.unregisterListeners(plugin);
		pluginManager.registerListener(plugin, new ChatListener(plugin, moduleManager));
		pluginManager.registerListener(plugin, new DisconnectListener(moduleManager));
		pluginManager.registerListener(plugin, new PluginMessageListener(plugin, moduleManager));
		pluginManager.registerListener(plugin, new PostLoginListener(plugin, moduleManager));

		pluginManager.unregisterCommands(plugin);
		pluginManager.registerCommand(plugin, new ExploitFixerCommand("exploitfixer", moduleManager));
		pluginManager.registerCommand(plugin, new ExploitFixerCommand("ef", moduleManager));
	}

	public static ExploitFixer getInstance() {
		return plugin;
	}
}