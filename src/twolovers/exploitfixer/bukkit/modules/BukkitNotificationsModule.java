package twolovers.exploitfixer.bukkit.modules;

import org.bukkit.Bukkit;
import org.bukkit.command.ConsoleCommandSender;
import org.bukkit.configuration.file.YamlConfiguration;
import org.bukkit.entity.Player;
import twolovers.exploitfixer.interfaces.modules.NotificationsModule;

import java.lang.reflect.InvocationTargetException;
import java.util.Collection;
import java.util.HashSet;

public class BukkitNotificationsModule implements NotificationsModule {
	private final Collection<Object> notifications = new HashSet<>();
	private boolean enabled;
	private String message;

	public BukkitNotificationsModule(final Object configYml) {
		reload(configYml);
	}

	public final void setNotifications(final Object player, final boolean input) {
		if (input)
			notifications.add(player);
		else
			notifications.remove(player);
	}

	public final boolean isNotifications(final Object player) {
		return notifications.contains(player);
	}

	public void sendNotification(final String check, final Object player, final int violations) {
		if (enabled && player != null) {
			final Player player1 = (Player) player;
			final ConsoleCommandSender consoleCommandSender = Bukkit.getConsoleSender();
			int ping = 0;

			try {
				final Object entityPlayer = player.getClass().getMethod("getHandle").invoke(player);
				ping = (int) entityPlayer.getClass().getField("ping").get(entityPlayer);
			} catch (IllegalAccessException | NoSuchFieldException | InvocationTargetException | NoSuchMethodException ignored) {
			}

			final String notification = message
					.replace("%player%", player1.getName())
					.replace("%check%", check)
					.replace("%ping%", String.valueOf(ping))
					.replace("%vls%", String.valueOf(violations));

			consoleCommandSender.sendMessage(notification);

			for (final Object player2 : getNotifications())
				((Player) player2).sendMessage(notification);
		}
	}

	public final Collection<Object> getNotifications() {
		return notifications;
	}

	public void reload(Object configYml) {
		final YamlConfiguration configYml1 = (YamlConfiguration) configYml;

		enabled = configYml1.getBoolean("notifications.enabled");
		message = configYml1.getString("notifications.message");

		if (message != null)
			message = message.replace("&", "\u00A7");
	}
}
