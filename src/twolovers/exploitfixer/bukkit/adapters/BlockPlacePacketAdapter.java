package twolovers.exploitfixer.bukkit.adapters;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketEvent;
import com.comphenix.protocol.reflect.StructureModifier;
import org.bukkit.Material;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;
import org.bukkit.plugin.Plugin;
import twolovers.exploitfixer.interfaces.managers.ModuleManager;
import twolovers.exploitfixer.interfaces.modules.PacketsModule;
import twolovers.exploitfixer.shared.enums.Identity;

public class BlockPlacePacketAdapter extends PacketAdapter {
	private final PacketsModule packetsModule;

	public BlockPlacePacketAdapter(final Plugin plugin, final ModuleManager moduleManager) {
		super(plugin, PacketType.Play.Client.BLOCK_PLACE);
		this.packetsModule = moduleManager.getPacketsModule();
	}

	@Override
	public void onPacketReceiving(final PacketEvent event) {
		final Player player = event.getPlayer();

		if (player != null) {
			final StructureModifier<ItemStack> itemModifier = event.getPacket().getItemModifier();

			if (itemModifier != null && itemModifier.size() > 0) {
				final ItemStack itemUse = itemModifier.read(0);

				if (itemUse != null) {
					final ItemStack itemOnHand = player.getItemInHand();

					if (itemUse.getType() == Material.WRITTEN_BOOK || itemUse.getType() == Material.BOOK_AND_QUILL)
						packetsModule.checkPacket(event, Identity.BLOCK_PLACE_BOOKS);
					else if (itemOnHand != null && itemUse.getType() != itemOnHand.getType())
						packetsModule.checkPacket(event, Identity.BLOCK_PLACE_WRONG);
					else
						packetsModule.checkPacket(event, Identity.BLOCK_PLACE);
				}

			}
		}
	}
}